<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Stream</title>
    </head>
    <body>
        <video id="stream"></video>
    </body>

    <script>
        class PeerConnectionStore {
            constructor() {
                this._connections = [];
            }

            AddPeer(pc) {
                this._connections.push({
                    connected: false,
                    pc: pc,
                });
            }

            Next() {
                for (let i = 0; i < this._connections.length; i++) {
                    if (!this._connections[i].connected) {
                        this._connections[i].connected = true;
                        return this._connections[i].pc;
                    }
                }
                return null;
            }
        }

        class P2PConnection {
            constructor(stream) {
                this._stream = stream;
                this._pc = this._newRTCPeerConn();

                this._initPeerConnectionEventListeners();
                this._initStreamToPeerConnection();
            }

            PeerConnection() {
                return this._pc;
            }

            NewOffer() {
                return new Promise((resolve, reject) => {
                    this._pc.onicecandidate = (event) => {
                        if (event.candidate === null) {
                            console.log("@ice candidate", event);
                            this._candidateExists = true;
                            resolve(this._pc.localDescription);
                        }
                    };

                    this._pc.createOffer().then((offer) => {
                        this._pc.setLocalDescription(offer);
                    });
                });
            }

            _newRTCPeerConn() {
                return new RTCPeerConnection({
                    iceServers: [
                        {
                            urls: [
                                "stun:stun.l.google.com:19302",
                                "stun:stun1.l.google.com:19302",
                                "stun:stun2.l.google.com:19302",
                                "stun:stun3.l.google.com:19302",
                                "stun:stun4.l.google.com:19302",
                            ],
                        },
                    ],
                });
            }

            _initPeerConnectionEventListeners() {
                this._pc.oniceconnectionstatechange = () => {
                    console.info(
                        "@ice connection state change:",
                        this._pc.iceConnectionState
                    );
                };

                this._pc.onicecandidateerror = (err) => {
                    console.error("@ice candidate error:", err);
                };
            }

            _initStreamToPeerConnection() {
                this._stream.getTracks().forEach((track) => {
                    this._pc.addTrack(track, this._stream);
                });
            }
        }

        class WebsocketStreamCreate {
            constructor(stream) {
                this._stream = stream;

                this._ws = this._newWebsocket();
                this._pcStore = new PeerConnectionStore();
            }

            _newWebsocket() {
                let ws = new WebSocket(
                    "ws://localhost:8080/api/v1/ws/stream/create"
                );

                ws.onerror = (err) => {
                    alert("ошибка подключения к серверу =(");
                    console.error("ws connection:", err);
                };

                ws.onopen = () => {
                    console.info("ws connection: success connect to server!");
                };

                ws.onmessage = ({ data }) => this._onmessage(JSON.parse(data));

                return ws;
            }

            _onmessage(json) {
                console.log("@onmessage:", json);

                if (json.error) return console.log("websocket error:", json);

                if (json.type) this._onmessageSetRemoteDesc(json);
                else this._onmessageNewConn();
            }

            _onmessageSetRemoteDesc(json) {
                let pc = this._pcStore.Next();
                pc.setRemoteDescription(new RTCSessionDescription(json));
            }

            _onmessageNewConn() {
                let p2p = new P2PConnection(this._stream);

                p2p.NewOffer().then((offer) => {
                    this._ws.send(JSON.stringify(offer));
                });

                this._pcStore.AddPeer(p2p.PeerConnection());
            }
        }

        function NewStream() {
            return navigator.mediaDevices.getDisplayMedia({
                video: {
                    width: {
                        ideal: 1366,
                    },
                    height: {
                        ideal: 768,
                    },
                    frameRate: (navigator.hardwareConcurrency)*(23/4)+7,
                },
            });
        }

        function main() {
            NewStream()
                .then((stream) => {
                    new WebsocketStreamCreate(stream);
                })
                .catch((err) => {
                    alert(err);
                });
        }

        window.onload = main();
    </script>
</html>
